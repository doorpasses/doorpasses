# Documented example: https://github.com/superfly/litefs/blob/dec5a7353292068b830001bd2df4830e646f6a2f/cmd/litefs/etc/litefs.yml
fuse:
  # Required. This is the mount directory that applications will
  # use to access their SQLite databases.
  dir: '${LITEFS_DIR}'

data:
  # Path to internal data storage.
  dir: '/data/litefs'

proxy:
  # matches the internal_port in fly.toml
  addr: ':${INTERNAL_PORT}'
  target: 'localhost:${PORT}'
  db: '${DATABASE_FILENAME}'

# The lease section specifies how the cluster will be managed. We're using the
# "consul" lease type so that our application can dynamically change the primary.
#
# IMPORTANT: Both apps must use the SAME consul key to share the database
lease:
  type: 'consul'
  # Admin app is typically not a candidate for primary (main app handles DB)
  candidate: false
  promote: true
  advertise-url: 'http://${HOSTNAME}.vm.${FLY_APP_NAME}.internal:20202'

  consul:
    url: '${FLY_CONSUL_URL}'
    # SHARED KEY: Both apps use the same key to share database leadership
    key: 'doorpasses-shared-db'

exec:
  # Admin app doesn't run migrations - main app handles this
  # - cmd: cd /myapp/packages/database && npx prisma migrate deploy
  #   if-candidate: true

  # No database setup - connects to shared database
  # - cmd: sqlite3 $DATABASE_PATH "PRAGMA journal_mode = WAL;"
  #   if-candidate: true

  # Generate Typed SQL files (still needed for app functionality)
  - cmd: cd /myapp/packages/database && npx prisma generate --sql

  - cmd: cd /myapp/apps/admin && npm start
