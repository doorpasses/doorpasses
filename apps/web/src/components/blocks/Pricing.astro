---
import GridDesign from '../GridDesign.astro'
import Button from '../ui/Button.astro'
import Badge from '../ui/Badge.astro'

interface Feature {
	name: string
	icon: string
	iconColor?: string
}

interface Plan {
	id: string
	title: string
	description: string
	highlight?: boolean
	currency?: string
	monthlyPrice: string
	yearlyPrice: string
	buttonText: string
	badge?: string
	features: Feature[]
}

interface Props {
	title?: string
	subtitle?: string
	plans?: Plan[]
	showFooter?: boolean
	footerText?: string
	footerButtonText?: string
	blockType: 'pricing'
}

const {
	title = 'Choose your plan',
	subtitle = 'Select the perfect plan for your needs',
	plans = [
		{
			id: 'starter',
			title: 'Starter',
			description: 'For developers testing out locally.',
			currency: '$',
			monthlyPrice: '0',
			yearlyPrice: '0',
			buttonText: 'Start today for free',
			features: [
				{ name: 'Authentication', icon: 'check' },
				{ name: 'Basic Support', icon: 'check' },
				{ name: 'Core Features', icon: 'check' },
			],
		},
		{
			id: 'pro',
			title: 'Pro',
			description: 'For companies in production.',
			currency: '$',
			monthlyPrice: '20',
			yearlyPrice: '199',
			buttonText: 'Sign up',
			badge: 'Most popular',
			highlight: true,
			features: [
				{ name: 'Everything in Starter', icon: 'check' },
				{ name: 'Priority Support', icon: 'check' },
				{ name: 'Advanced Analytics', icon: 'check' },
				{ name: 'Team Collaboration', icon: 'check' },
			],
		},
		{
			id: 'enterprise',
			title: 'Enterprise',
			description: 'For organizations with advanced needs.',
			currency: '$',
			monthlyPrice: 'Custom',
			yearlyPrice: 'Custom',
			buttonText: 'Contact sales',
			features: [
				{ name: 'Everything in Pro', icon: 'check' },
				{ name: 'Custom Integration', icon: 'check' },
				{ name: 'Dedicated Support', icon: 'check' },
				{ name: 'SLA & Compliance', icon: 'check' },
			],
		},
	],
	showFooter = true,
	footerText = 'Pre-negotiated discounts are available to early-stage startups and nonprofits.',
	footerButtonText = 'Apply now',
} = Astro.props

// Calculate discount percentage
const calculateDiscount = (monthlyPrice: string, yearlyPrice: string): number => {
	const monthly = parseFloat(monthlyPrice)
	const yearly = parseFloat(yearlyPrice)

	if (
		monthlyPrice.toLowerCase() === 'custom' ||
		yearlyPrice.toLowerCase() === 'custom' ||
		isNaN(monthly) ||
		isNaN(yearly) ||
		monthly === 0
	) {
		return 0
	}

	const discount = ((monthly * 12 - yearly) / (monthly * 12)) * 100
	return Math.round(discount)
}

const yearlyDiscount = plans.length
	? Math.max(...plans.map((plan) => calculateDiscount(plan.monthlyPrice, plan.yearlyPrice)))
	: 0
---

<section class="relative w-full py-16 md:py-24">
	<GridDesign />
	<div class="container relative mx-auto px-4 md:px-6">
		<!-- Header -->
		<div class="text-center mb-12">
			<Badge variant="outline" size="sm">
				PRICING PLANS
			</Badge>
			<h2 class="text-4xl md:text-6xl tracking-tight font-title mb-4">
				{title}
			</h2>
			<p class="text-xl text-muted-foreground max-w-[600px] mx-auto">
				{subtitle}
			</p>
		</div>

		<!-- Pricing Toggle -->
		<div class="flex flex-col justify-center items-center mb-12">
			<div class="inline-flex items-center justify-center bg-muted p-[1px] text-muted-foreground" id="pricing-toggle" role="group" aria-label="Billing period">
				<button 
					class="inline-flex items-center justify-center whitespace-nowrap px-6 py-2 text-sm font-medium transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-background text-foreground border border-border shadow-sm cursor-pointer" 
					data-period="monthly"
					id="monthly-btn"
					aria-pressed="true"
				>
					Monthly
				</button>
				<button 
					class="inline-flex items-center justify-center whitespace-nowrap px-6 py-2 text-sm font-medium transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 text-muted-foreground cursor-pointer" 
					data-period="yearly"
					id="yearly-btn"
					aria-pressed="false"
				>
					Yearly
				</button>
			</div>
			{yearlyDiscount > 0 && (
				<div class="flex items-center gap-2 mt-4">
					<div class="w-2 h-2 bg-primary rounded-sm"></div>
					<span class="text-sm text-muted-foreground" id="discount-text">
						Save up to {yearlyDiscount}% with yearly plan
					</span>
				</div>
			)}
		</div>

		<!-- Pricing Cards -->
		<div class={`grid p-[1px] ${
			plans.length === 1 ? 'grid-cols-1 max-w-md mx-auto' :
			plans.length === 2 ? 'grid-cols-1 md:grid-cols-2 max-w-4xl mx-auto' :
			plans.length === 3 ? 'grid-cols-1 md:grid-cols-3' :
			'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'
		}`}>
			{plans.map((plan) => (
				<div class={`group relative transition-all duration-200 ${
					plan.highlight 
						? 'ring-2 ring-primary/50 hover:ring-primary z-10' 
						: 'hover:shadow-lg'
				}`}>
					{plan.badge && (
						<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-primary text-primary-foreground px-3 py-1 text-xs rounded-full border-[0.5px] border-white/20 shadow-sm shadow-black/8">
							{plan.badge}
						</div>
					)}
					
					<div class="bg-card overflow-hidden shadow-sm flex flex-col h-full">
						<!-- Card Header -->
						<header class="px-6 py-4">
							<div class="space-y-1">
								<h3 class="text-base font-medium text-card-foreground flex items-center gap-2">
									{plan.title}
								</h3>
								<p class="text-sm text-muted-foreground leading-relaxed text-pretty">
									{plan.description}
								</p>
							</div>
						</header>
						
						<!-- Card Body - Pricing -->
						<div class="border-t border-border/50 px-6 py-5 space-y-1">
							<!-- Monthly Price -->
							<div class="pricing-monthly">
								<div class="flex items-baseline gap-1">
									<span class="text-3xl font-bold text-primary">
										{parseFloat(plan.monthlyPrice) >= 0 && plan.currency}
										{plan.monthlyPrice}
									</span>
									{parseFloat(plan.monthlyPrice) >= 0 && (
										<span class="text-muted-foreground text-sm">/month</span>
									)}
								</div>
							</div>
							<!-- Yearly Price -->
							<div class="pricing-yearly hidden flex gap-4">
								<div class="flex items-baseline gap-1">
									<span class="text-3xl font-bold text-primary">
										{parseFloat(plan.yearlyPrice) >= 0 && plan.currency}
										{plan.yearlyPrice}
									</span>
									{parseFloat(plan.yearlyPrice) >= 0 && (
										<span class="text-muted-foreground text-sm">/year</span>
									)}
								</div>
								{calculateDiscount(plan.monthlyPrice, plan.yearlyPrice) > 0 && (
									<div class="mt-1">
										<span class="inline-flex items-center gap-1 text-xs font-medium text-primary bg-primary/10 px-2 py-0.5 rounded-md">
											Save {calculateDiscount(plan.monthlyPrice, plan.yearlyPrice)}%
										</span>
									</div>
								)}
							</div>
						</div>

						<!-- Card Body - Features -->
						<div class="border-t border-border/50 p-5.5 space-y-3 flex-1">
							{plan.features.map((feature) => (
								<div class="flex items-start gap-3">
									<div class="w-2 h-2 bg-primary rounded-sm flex-shrink-0 mt-1.5"></div>
									<span class="text-sm text-card-foreground leading-relaxed flex-1">{feature.name}</span>
								</div>
							))}
						</div>

						<!-- Card Footer -->
						<footer class="border-t border-border/50 px-5 py-3 pb-4">
							<Button
								href={`#plan-${plan.id}`}
								variant={plan.highlight ? 'default' : 'secondary'}
								class="w-full"
							>
								{plan.buttonText}
							</Button>
						</footer>
					</div>
				</div>
			))}
		</div>

		<!-- Footer -->
		{showFooter && (
			<div class={`px-[1px] mt-2 ${
				plans.length === 1 ? 'max-w-md mx-auto' :
				plans.length === 2 ? 'max-w-4xl mx-auto' : ''
			}`}>
				<div class="bg-card p-6 border-y border-border border-dashed">
					<div class="flex flex-col md:flex-row gap-4 justify-between items-center w-full">
						<p class="text-base text-card-foreground text-left flex-1">
							{footerText}
						</p>
						<Button
							href="#apply"
							variant="secondary"
							class="whitespace-nowrap"
						>
							{footerButtonText}
						</Button>
					</div>
				</div>
			</div>
		)}
	</div>
</section>

<script>
	// Pricing toggle functionality
	document.addEventListener('DOMContentLoaded', function() {
		const monthlyBtn = document.getElementById('monthly-btn')
		const yearlyBtn = document.getElementById('yearly-btn')
		const discountText = document.getElementById('discount-text')
		
		if (!monthlyBtn || !yearlyBtn) return

		function setActiveButton(activeBtn: HTMLElement, inactiveBtn: HTMLElement) {
			// Update active button styles
			activeBtn.classList.add('bg-background', 'text-foreground', 'border', 'border-border', 'shadow-sm')
			activeBtn.classList.remove('text-muted-foreground')
			activeBtn.setAttribute('aria-pressed', 'true')
			
			// Update inactive button styles
			inactiveBtn.classList.remove('bg-background', 'text-foreground', 'border', 'border-border', 'shadow-sm')
			inactiveBtn.classList.add('text-muted-foreground')
			inactiveBtn.setAttribute('aria-pressed', 'false')
		}

		function togglePricing(period: string) {
			const monthlyPrices = document.querySelectorAll('.pricing-monthly')
			const yearlyPrices = document.querySelectorAll('.pricing-yearly')
			
			if (period === 'yearly') {
				monthlyPrices.forEach(el => el.classList.add('hidden'))
				yearlyPrices.forEach(el => el.classList.remove('hidden'))
				setActiveButton(yearlyBtn as HTMLElement, monthlyBtn as HTMLElement)
				if (discountText) discountText.style.opacity = '1'
			} else {
				yearlyPrices.forEach(el => el.classList.add('hidden'))
				monthlyPrices.forEach(el => el.classList.remove('hidden'))
				setActiveButton(monthlyBtn as HTMLElement, yearlyBtn as HTMLElement)
				if (discountText) discountText.style.opacity = '0.7'
			}
		}

		// Add click event listeners
		monthlyBtn.addEventListener('click', () => togglePricing('monthly'))
		yearlyBtn.addEventListener('click', () => togglePricing('yearly'))
		
		// Initialize with monthly view
		togglePricing('monthly')
	})
</script>
