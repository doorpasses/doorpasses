---
import MarketingLayout from '../layouts/MarketingLayout.astro'
import { logos } from '../data/logos'
import { cmsClient } from '../lib/cms'
import RenderHero from '../components/RenderHero.astro'
import RenderBlocks from '../components/RenderBlocks.astro'
import GridDesign from '../components/GridDesign.astro'

// Fetch recent blog posts using cmsClient
const recentPostsData = await cmsClient.getPosts(1, 3)
const recentPosts = recentPostsData

// Try to fetch home page content from CMS
const homePage = await cmsClient.getHomePage()
---

<MarketingLayout>
	{/* If we have CMS content for home page, use it */}
	{
		homePage ? (
			<article>
				{/* SEO Meta Tags for home page */}
				<Fragment slot="head">
					<title>
						{homePage.meta?.title || homePage.title || 'The Epic Stack'}
					</title>
					{homePage.meta?.description && (
						<meta name="description" content={homePage.meta.description} />
					)}
					{homePage.meta?.image &&
						typeof homePage.meta.image === 'object' &&
						homePage.meta.image.url && (
							<>
								<meta property="og:image" content={homePage.meta.image.url} />
								<meta name="twitter:image" content={homePage.meta.image.url} />
							</>
						)}
				</Fragment>

				{/* Render CMS Hero Section */}
				{homePage.hero && (
					<div>
						<RenderHero {...homePage.hero} />
					</div>
				)}

				{/* Render CMS Layout Blocks */}
				{homePage.layout && homePage.layout.length > 0 && (
					<RenderBlocks blocks={homePage.layout} />
				)}
			</article>
		) : (
			/* Fallback to original static home page */
			<main class="font-poppins grid h-full place-items-center">
				<div class="grid place-items-center px-4 py-16 xl:grid-cols-2 xl:gap-24">
					<div class="flex max-w-md flex-col items-center text-center xl:order-2 xl:items-start xl:text-left">
						<a
							href="https://www.epicweb.dev/stack"
							class="animate-slide-top xl:animate-slide-left [animation-fill-mode:backwards] xl:[animation-delay:0.5s] xl:[animation-fill-mode:backwards]"
						>
							<svg
								class="text-foreground size-20 xl:-mt-4"
								xmlns="http://www.w3.org/2000/svg"
								fill="none"
								viewBox="0 0 65 65"
							>
								<path
									fill="currentColor"
									d="M39.445 25.555 37 17.163 65 0 47.821 28l-8.376-2.445Zm-13.89 0L28 17.163 0 0l17.179 28 8.376-2.445Zm13.89 13.89L37 47.837 65 65 47.821 37l-8.376 2.445Zm-13.89 0L28 47.837 0 65l17.179-28 8.376 2.445Z"
								/>
							</svg>
						</a>
						<h1
							data-heading
							class="animate-slide-top text-foreground xl:animate-slide-left mt-8 text-4xl font-medium [animation-delay:0.3s] [animation-fill-mode:backwards] md:text-5xl xl:mt-4 xl:text-6xl xl:[animation-delay:0.8s] xl:[animation-fill-mode:backwards]"
						>
							<a href="https://www.epicweb.dev/stack">The Epic Stack</a>
						</h1>
						<p
							data-paragraph
							class="animate-slide-top text-muted-foreground xl:animate-slide-left mt-6 text-xl/7 [animation-delay:0.8s] [animation-fill-mode:backwards] xl:mt-8 xl:text-xl/6 xl:leading-10 xl:[animation-delay:1s] xl:[animation-fill-mode:backwards]"
						>
							Check the{' '}
							<a
								class="underline hover:no-underline"
								href="https://github.com/epicweb-dev/epic-stack/blob/main/docs/getting-started.md"
							>
								Getting Started guide
							</a>{' '}
							file for how to get your project off the ground!
						</p>
					</div>
					<ul class="mt-16 flex max-w-3xl flex-wrap justify-center gap-2 sm:gap-4 xl:mt-0 xl:grid xl:grid-flow-col xl:grid-cols-5 xl:grid-rows-6">
						{logos.map((logo, i) => (
							<li
								class={`animate-roll-reveal [animation-fill-mode:backwards]`}
								style={{ animationDelay: `${i * 0.07}s` }}
							>
								<a
									href={logo.href}
									class="grid size-20 place-items-center rounded-2xl bg-violet-600/10 p-4 transition hover:-rotate-6 hover:bg-violet-600/15 sm:size-24 dark:bg-violet-200 dark:hover:bg-violet-100"
								>
									<img src={logo.src} alt={logo.alt} />
								</a>
							</li>
						))}
					</ul>
				</div>
			</main>
		)
	}

	<!-- Blog Section -->
	{
		recentPosts.docs && recentPosts.docs.length > 0 && (
			<section class="relative w-full py-16 md:py-24">
				<GridDesign />
				<div class="container relative mx-auto px-4 md:px-6">
					<div class="text-center mb-12">
						<h3 class="font-mono text-sm uppercase tracking-wide text-muted-foreground mb-6">
							// LATEST INSIGHTS
						</h3>
						<h2 class="text-4xl md:text-6xl font-light text-primary mb-4">
							From our blog
						</h2>
						<p class="text-xl text-muted-foreground max-w-[600px] mx-auto">
							Stay updated with our latest insights, tutorials, and product
							updates
						</p>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-3 border-l border-t border-dashed gap-0">
						{recentPosts.docs.map((post, idx) => (
							<article class="border-b border-r border-dashed bg-background hover:bg-gradient-to-b from-muted/5 to-muted/50 transition-colors">
								{post.meta?.image && (
									<div class="aspect-video overflow-hidden border-b border-dashed">
										<img
											src={post.meta.image.url}
											alt={post.meta.image.alt || post.title}
											class="w-full h-full object-cover"
										/>
									</div>
								)}
								<div class="py-4 space-y-4">
									<h3 class="text-lg font-semibold text-primary border-l-2 border-primary pl-4">
										<a
											href={`/posts/${post.slug}`}
											class="hover:text-primary/80 transition-colors"
											set:html={post.title}
										/>
									</h3>
									{post.meta?.description && (
										<p
											class="text-muted-foreground text-sm leading-relaxed pl-4"
											set:html={post.meta.description}
										/>
									)}
									<a
										href={`/posts/${post.slug}`}
										class="inline-flex items-center text-sm font-medium text-primary hover:text-primary/80 border-b-2 border-transparent hover:border-primary/80 transition-colors pl-4"
									>
										Read more
										<svg
											class="ml-1 w-4 h-4"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
											xmlns="http://www.w3.org/2000/svg"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M17 8l4 4m0 0l-4 4m4-4H3"
											/>
										</svg>
									</a>
								</div>
							</article>
						))}
					</div>

					<div class="text-center mt-12">
						<a
							href="/posts"
							class="inline-flex items-center text-lg font-medium text-primary hover:text-primary/80 border-b-2 border-transparent hover:border-primary/80 transition-colors"
						>
							View all posts
							<svg
								class="ml-2 w-4 h-4"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
								xmlns="http://www.w3.org/2000/svg"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M17 8l4 4m0 0l-4 4m4-4H3"
								/>
							</svg>
						</a>
					</div>
				</div>
			</section>
		)
	}
</MarketingLayout>
