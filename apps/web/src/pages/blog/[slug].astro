---
import MarketingLayout from '../../layouts/MarketingLayout.astro'
import { cmsClient } from '../../lib/cms'

const { title, content, meta, publishedAt, categories, heroImage } = Astro.props

// Use cmsClient but follow guide patterns for getStaticPaths
export async function getStaticPaths() {
  const posts = await cmsClient.getPosts(1, 100) // Get all posts for static generation
  
  return posts.docs.map((post) => {
    return {
      params: { slug: post.slug },
      props: { 
        title: post.title, 
        content: post.content,
        meta: post.meta,
        publishedAt: post.publishedAt,
        categories: post.categories,
        heroImage: post.heroImage
      },
    }
  })
}

const formattedDate = publishedAt ? new Date(publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) : null

// Simple content renderer for Lexical content
const renderLexicalContent = (content: any) => {
  if (!content || !content.root || !content.root.children) {
    return ''
  }
  
  return content.root.children.map((node: any) => {
    if (node.type === 'paragraph' && node.children) {
      const text = node.children.map((child: any) => child.text || '').join('')
      return `<p>${text}</p>`
    }
    if (node.type === 'heading' && node.children) {
      const text = node.children.map((child: any) => child.text || '').join('')
      const tag = node.tag || 'h2'
      return `<${tag}>${text}</${tag}>`
    }
    return ''
  }).join('')
}
---

<MarketingLayout>
  <article class="min-h-screen py-24">
    <div class="container mx-auto px-4 max-w-4xl">
      <!-- Header -->
      <header class="mb-12 text-center">
        {categories && categories.length > 0 && (
          <div class="mb-4">
            {categories.map((category) => (
              <span 
                class="inline-block bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full mr-2"
              >
                {typeof category === 'object' ? category.title : category}
              </span>
            ))}
          </div>
        )}
        
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6" set:html={title} />
        
        {meta?.description && (
          <p class="text-xl text-gray-600 mb-6" set:html={meta.description} />
        )}
        
        {formattedDate && (
          <time class="text-gray-500" datetime={publishedAt}>
            Published on {formattedDate}
          </time>
        )}
      </header>

      <!-- Hero Image -->
      {heroImage && typeof heroImage === 'object' && heroImage.url && (
        <div class="mb-12">
          <img 
            src={heroImage.url} 
            alt={heroImage.alt || title} 
            class="w-full h-64 md:h-96 object-cover rounded-lg shadow-lg"
          />
        </div>
      )}

      <!-- Content - using set:html as recommended in the guide -->
      <div class="prose prose-lg max-w-none">
        {content ? (
          <div set:html={renderLexicalContent(content)} />
        ) : (
          <p>No content available.</p>
        )}
      </div>

      <!-- Back to posts -->
      <div class="mt-12 pt-8 border-t border-gray-200">
        <a 
          href="/posts" 
          class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium"
        >
          ‚Üê Back to all posts
        </a>
      </div>
    </div>
  </article>
</MarketingLayout>