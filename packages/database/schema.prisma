generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql"]
  binaryTargets   = ["native", "darwin-arm64", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                     @id @default(cuid())
  email                  String                     @unique
  username               String                     @unique
  name                   String?
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  isBanned               Boolean                    @default(false)
  banReason              String?
  banExpiresAt           DateTime?
  bannedAt               DateTime?
  bannedById             String?
  bannedBy               User?                      @relation("UserBans", fields: [bannedById], references: [id])
  bannedUsers            User[]                     @relation("UserBans")
  connections            Connection[]
  notes                  Note[]
  noteAccess             NoteAccess[]
  targetedActivityLogs   NoteActivityLog[]          @relation("ActivityLogTarget")
  activityLogs           NoteActivityLog[]
  noteComments           NoteComment[]
  onboardingProgress     OnboardingProgress[]
  onboardingStepProgress OnboardingStepProgress[]
  sentInvitations        OrganizationInvitation[]   @relation("inviter")
  createdInviteLinks     OrganizationInviteLink[]
  createdOrgNotes        OrganizationNote[]         @relation("createdBy")
  passkey                Passkey[]
  password               Password?
  sessions               Session[]
  refreshTokens          RefreshToken[]
  image                  UserImage?
  organizations          UserOrganization[]
  utmSource              UtmSource?
  roles                  Role[]                     @relation("RoleToUser")
  orgNoteFavorites       OrganizationNoteFavorite[]
  Feedback               Feedback[]
  blacklistedIps         IpAddress[]                @relation("IpBlacklists")
  ipAddressUsers         IpAddressUser[]
  apiKeys                ApiKey[]
  configFlags            ConfigFlag[]
  createdSSOConfigs      SSOConfiguration[]         @relation("SSOConfigCreatedBy")
  auditLogs              AuditLog[]                 @relation("AuditLogUser")
  waitlistEntry          WaitlistEntry?
  grantedWaitlistAccess  WaitlistEntry[]            @relation("AccessGranter")
  mcpAuthorizations      MCPAuthorization[]
  createdCardTemplates   CardTemplate[]             @relation("CardTemplateCreatedBy")
  createdAccessPasses    AccessPass[]               @relation("AccessPassCreatedBy")
}

model Note {
  id        String      @id @default(cuid())
  title     String
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  ownerId   String
  owner     User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  images    NoteImage[]

  @@index([ownerId])
  @@index([ownerId, updatedAt])
}

model NoteImage {
  id        String   @id @default(cuid())
  altText   String?
  objectKey String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
}

model UserImage {
  id        String   @id @default(cuid())
  altText   String?
  objectKey String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Password {
  hash   String
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id             String      @id @default(cuid())
  expirationDate DateTime
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  ssoSession     SSOSession?

  @@index([userId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  tokenHash String    // Hashed refresh token for security
  userId    String
  userAgent String?   // Device/browser info
  ipAddress String?   // IP address for security tracking
  revoked   Boolean   @default(false)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, revoked])
  @@index([expiresAt])
}

model Permission {
  id                String             @id @default(cuid())
  action            String // create, read, update, delete, manage
  entity            String // note, user, org_note, org_member, org_settings
  access            String // own, any, org
  context           String             @default("system") // system, organization
  description       String             @default("")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  roles             Role[]             @relation("PermissionToRole")
  organizationRoles OrganizationRole[] @relation("OrganizationPermissionToRole")

  @@unique([action, entity, access, context])
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  description String       @default("")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  permissions Permission[] @relation("PermissionToRole")
  users       User[]       @relation("RoleToUser")
}

model Verification {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  /// The type of verification, e.g. "email" or "phone"
  type      String
  /// The thing we're trying to verify, e.g. a user's email or phone number
  target    String
  /// The secret key used to generate the otp
  secret    String
  /// The algorithm used to generate the otp
  algorithm String
  /// The number of digits in the otp
  digits    Int
  /// The number of seconds the otp is valid for
  period    Int
  /// The valid characters for the otp
  charSet   String
  /// When it's safe to delete this verification
  expiresAt DateTime?

  @@unique([target, type])
}

model Connection {
  id           String   @id @default(cuid())
  providerName String
  providerId   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerName, providerId])
}

model Passkey {
  id             String   @id
  aaguid         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  publicKey      Bytes
  userId         String
  webauthnUserId String
  counter        BigInt
  deviceType     String
  backedUp       Boolean
  transports     String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Organization {
  id                     String                   @id @default(cuid())
  name                   String
  slug                   String                   @unique
  description            String?
  active                 Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  planName               String?
  stripeCustomerId       String?
  stripeProductId        String?
  stripeSubscriptionId   String?
  subscriptionStatus     String?
  size                   String?
  verifiedDomain         String?
  integrations           Integration[]
  onboardingProgress     OnboardingProgress[]
  onboardingStepProgress OnboardingStepProgress[]
  image                  OrganizationImage?
  invitations            OrganizationInvitation[]
  inviteLinks            OrganizationInviteLink[]
  notes                  OrganizationNote[]
  noteStatuses           OrganizationNoteStatus[]
  users                  UserOrganization[]
  s3Config               OrganizationS3Config?
  ssoConfiguration       SSOConfiguration?
  auditLogs              AuditLog[]
  auditRetentionPolicy   AuditLogRetentionPolicy?
  Feedback               Feedback[]
  apiKeys                ApiKey[]
  configFlags            ConfigFlag[]
  mcpAuthorizations      MCPAuthorization[]
  cardTemplates          CardTemplate[]
  webhooks               Webhook[]
}

model OrganizationRole {
  id          String   @id @default(cuid())
  name        String   @unique // admin, member, viewer, guest
  description String   @default("")
  level       Int // Hierarchy: admin=4, member=3, viewer=2, guest=1
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions Permission[]             @relation("OrganizationPermissionToRole")
  users       UserOrganization[]
  invitations OrganizationInvitation[]
  inviteLinks OrganizationInviteLink[]

  @@index([level])
}

model UserOrganization {
  userId             String
  organizationId     String
  organizationRoleId String
  organizationRole   OrganizationRole @relation(fields: [organizationRoleId], references: [id])
  active             Boolean          @default(true)
  isDefault          Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  department         String?
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([organizationRoleId])
}

model OrganizationImage {
  id             String       @id @default(cuid())
  altText        String?
  objectKey      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model OrganizationS3Config {
  id              String       @id @default(cuid())
  isEnabled       Boolean      @default(false)
  endpoint        String
  bucketName      String
  accessKeyId     String
  secretAccessKey String // This should be encrypted in production
  region          String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organizationId  String       @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model OrganizationInvitation {
  id                 String           @id @default(cuid())
  email              String
  organizationRoleId String
  organizationRole   OrganizationRole @relation(fields: [organizationRoleId], references: [id])
  token              String           @unique
  expiresAt          DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  organizationId     String
  inviterId          String?
  inviter            User?            @relation("inviter", fields: [inviterId], references: [id])
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([organizationRoleId])
}

model OrganizationInviteLink {
  id                 String           @id @default(cuid())
  token              String           @unique
  organizationRoleId String
  organizationRole   OrganizationRole @relation(fields: [organizationRoleId], references: [id])
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  organizationId     String
  createdById        String
  createdBy          User             @relation(fields: [createdById], references: [id])
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, createdById])
  @@index([organizationId])
  @@index([createdById])
  @@index([organizationRoleId])
}

model UtmSource {
  id        String   @id @default(cuid())
  source    String?
  medium    String?
  campaign  String?
  term      String?
  content   String?
  referrer  String?
  createdAt DateTime @default(now())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OrganizationNote {
  id                     String                      @id @default(cuid())
  title                  String
  content                String
  isPublic               Boolean                     @default(true)
  priority               String? // "low", "medium", "high"
  tags                   String? // JSON array of tags stored as string
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt
  organizationId         String
  createdById            String
  statusId               String? // Kanban column FK, null = Uncategorized
  status                 OrganizationNoteStatus?     @relation(fields: [statusId], references: [id], onDelete: SetNull)
  position               Float? // Ordering within status
  noteAccess             NoteAccess[]
  activityLogs           NoteActivityLog[]
  comments               NoteComment[]
  integrationConnections NoteIntegrationConnection[]
  createdBy              User                        @relation("createdBy", fields: [createdById], references: [id], onDelete: Cascade)
  organization           Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploads                OrganizationNoteUpload[]
  favorites              OrganizationNoteFavorite[]

  @@index([organizationId])
  @@index([createdById])
  @@index([organizationId, updatedAt])
  @@index([organizationId, statusId, position])
}

model OrganizationNoteUpload {
  id           String           @id @default(cuid())
  type         String // "image" or "video"
  altText      String?
  objectKey    String
  thumbnailKey String? // Only used for videos
  duration     Int? // Only used for videos
  fileSize     Int?
  mimeType     String?
  status       String           @default("completed") // processing, completed, failed (mainly for videos)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  noteId       String
  note         OrganizationNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([type])
  @@index([status])
  @@index([noteId, type])
}

model Integration {
  id             String                      @id @default(cuid())
  organizationId String
  providerName   String
  providerType   String
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  config         String
  isActive       Boolean                     @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  organization   Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  logs           IntegrationLog[]
  activityLogs   NoteActivityLog[]
  connections    NoteIntegrationConnection[]

  @@unique([organizationId, providerName])
  @@index([organizationId])
}

model NoteIntegrationConnection {
  id            String           @id @default(cuid())
  noteId        String
  integrationId String
  externalId    String
  config        String
  isActive      Boolean          @default(true)
  lastPostedAt  DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  integration   Integration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  note          OrganizationNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, integrationId, externalId])
  @@index([noteId])
  @@index([integrationId])
}

model IntegrationLog {
  id            String      @id @default(cuid())
  integrationId String
  action        String
  status        String
  requestData   String?
  responseData  String?
  errorMessage  String?
  createdAt     DateTime    @default(now())
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([createdAt])
}

model NoteAccess {
  id        String           @id @default(cuid())
  noteId    String
  userId    String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  note      OrganizationNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, userId])
  @@index([noteId])
  @@index([userId])
}

model NoteComment {
  id        String             @id @default(cuid())
  content   String
  noteId    String
  userId    String
  parentId  String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  parent    NoteComment?       @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   NoteComment[]      @relation("CommentReplies")
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  note      OrganizationNote   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  images    NoteCommentImage[]

  @@index([noteId])
  @@index([userId])
  @@index([parentId])
  @@index([noteId, createdAt])
}

model NoteCommentImage {
  id        String      @id @default(cuid())
  altText   String?
  objectKey String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  commentId String
  comment   NoteComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([commentId])
}

model NoteActivityLog {
  id            String           @id @default(cuid())
  noteId        String
  userId        String
  action        String
  metadata      String?
  targetUserId  String?
  integrationId String?
  commentId     String?
  createdAt     DateTime         @default(now())
  integration   Integration?     @relation(fields: [integrationId], references: [id])
  targetUser    User?            @relation("ActivityLogTarget", fields: [targetUserId], references: [id])
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  note          OrganizationNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([userId])
  @@index([noteId, createdAt])
  @@index([action])
}

model OnboardingStep {
  id           String                   @id @default(cuid())
  key          String                   @unique
  title        String
  description  String
  icon         String?
  actionConfig String?
  isActive     Boolean                  @default(true)
  sortOrder    Int                      @default(0)
  autoDetect   Boolean                  @default(false)
  detectConfig String?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  userProgress OnboardingStepProgress[]

  @@index([isActive, sortOrder])
}

model OnboardingStepProgress {
  id             String         @id @default(cuid())
  userId         String
  organizationId String
  stepId         String
  isCompleted    Boolean        @default(false)
  completedAt    DateTime?
  metadata       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  step           OnboardingStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, stepId])
  @@index([userId, organizationId])
  @@index([stepId])
}

model OnboardingProgress {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  totalSteps     Int          @default(0)
  completedCount Int          @default(0)
  isCompleted    Boolean      @default(false)
  completedAt    DateTime?
  isVisible      Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model OrganizationNoteFavorite {
  id        String           @id @default(cuid())
  userId    String
  noteId    String
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  note      OrganizationNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([userId, noteId])
  @@index([userId])
  @@index([noteId])
}

model OrganizationNoteStatus {
  id                String             @id @default(cuid())
  organizationId    String
  name              String
  color             String?            @default("#6b7280") // Default gray color
  position          Float?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationNotes OrganizationNote[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, position])
}

model Feedback {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  message        String
  type           String
  userId         String
  organizationId String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
}

model IpAddress {
  id              String          @id @default(cuid())
  ip              String          @unique
  country         String?
  region          String?
  city            String?
  isBlacklisted   Boolean         @default(false)
  blacklistReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  blacklistedAt   DateTime?
  blacklistedById String?
  blacklistedBy   User?           @relation("IpBlacklists", fields: [blacklistedById], references: [id])
  // Simple tracking fields instead of storing every request
  requestCount    Int             @default(0)
  lastRequestAt   DateTime?
  lastUserAgent   String?
  suspiciousScore Int             @default(0) // For future fraud detection
  ipAddressUsers  IpAddressUser[]

  @@index([ip])
  @@index([isBlacklisted])
  @@index([suspiciousScore])
}

model IpAddressUser {
  id           String    @id @default(cuid())
  userId       String
  ipAddressId  String
  firstSeenAt  DateTime  @default(now())
  lastSeenAt   DateTime  @default(now())
  requestCount Int       @default(1)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress    IpAddress @relation(fields: [ipAddressId], references: [id], onDelete: Cascade)

  @@unique([userId, ipAddressId])
  @@index([userId])
  @@index([ipAddressId])
}

model ApiKey {
  id             String       @id @default(cuid())
  key            String       @unique
  name           String
  userId         String
  organizationId String
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([key])
}

enum ConfigFlagLevel {
  system
  organization
  user
}

model ConfigFlag {
  id             String          @id @default(cuid())
  key            String
  value          Json
  level          ConfigFlagLevel
  organizationId String?
  userId         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([key, level, organizationId, userId])
  @@index([key])
  @@index([level])
  @@index([organizationId])
  @@index([userId])
}

model SSOConfiguration {
  id                String       @id @default(cuid())
  organizationId    String       @unique
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Identity Provider Configuration
  providerName      String       // "okta", "azure-ad", "auth0", etc.
  issuerUrl         String       // Base URL of the identity provider
  clientId          String       // OAuth2 client ID
  clientSecret      String       // Encrypted OAuth2 client secret
  
  // OAuth2 Endpoints (can be auto-discovered or manually configured)
  authorizationUrl  String?      // Authorization endpoint
  tokenUrl          String?      // Token endpoint
  userinfoUrl       String?      // UserInfo endpoint
  revocationUrl     String?      // Token revocation endpoint
  
  // Configuration Options
  scopes            String       @default("openid email profile") // Space-separated scopes
  autoDiscovery     Boolean      @default(true) // Use OIDC discovery
  pkceEnabled       Boolean      @default(true) // Use PKCE for security
  
  // User Provisioning Settings
  autoProvision     Boolean      @default(true) // Auto-create users
  defaultRole       String       @default("member") // Default organization role
  attributeMapping  String?      // JSON mapping of OIDC claims to user fields
  
  // Status and Metadata
  isEnabled         Boolean      @default(false)
  lastTested        DateTime?    // Last successful connection test
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  // Audit Trail
  createdById       String?
  createdBy         User?        @relation("SSOConfigCreatedBy", fields: [createdById], references: [id])
  
  // Relations
  ssoSessions       SSOSession[]
  
  @@index([organizationId])
  @@index([isEnabled])
}

model SSOSession {
  id                String           @id @default(cuid())
  sessionId         String           @unique
  session           Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  ssoConfigId       String
  ssoConfig         SSOConfiguration @relation(fields: [ssoConfigId], references: [id])
  
  // Identity Provider Data
  providerUserId    String           // User ID from identity provider
  accessToken       String?          // Encrypted access token
  refreshToken      String?          // Encrypted refresh token
  tokenExpiresAt    DateTime?        // Access token expiration
  
  // Session Metadata
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([ssoConfigId])
  @@index([providerUserId])
}

model AuditLog {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  // Action details
  action         String        // e.g., "user_login", "note_created", etc.
  details        String        // Human-readable description
  metadata       String?       // JSON metadata for additional context

  // Request context (for security and compliance)
  ipAddress      String?       // Source IP address
  userAgent      String?       // Browser/client user agent

  // Resource tracking (for resource-specific audits)
  resourceType   String?       // Type of resource (user, note, org, etc.)
  resourceId     String?       // ID of the affected resource
  targetUserId   String?       // For user management actions

  // Compliance and retention
  severity       String        @default("info") // info, warning, error, critical
  retainUntil    DateTime?     // When this log can be safely deleted (compliance-aware)
  archived       Boolean       @default(false) // Whether moved to cold storage

  // Timestamps (immutable - do not update after creation)
  createdAt      DateTime      @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([resourceType, resourceId])
  @@index([organizationId, createdAt])
  @@index([archived, retainUntil])
  @@index([targetUserId])
}

model AuditLogRetentionPolicy {
  id               String       @id @default(cuid())
  organizationId   String       @unique
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Retention configuration
  retentionDays    Int          @default(365) // Default: 1 year
  hotStorageDays   Int          @default(180) // Keep 6 months in hot storage
  archiveEnabled   Boolean      @default(true) // Enable automatic archiving
  exportEnabled    Boolean      @default(true) // Allow audit log exports

  // Compliance settings
  complianceType   String?      // "SOC2", "HIPAA", "GDPR", "PCI_DSS", etc.
  immutable        Boolean      @default(true) // Prevent modifications

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([organizationId])
}

model WaitlistEntry {
  id               String           @id @default(cuid())
  userId           String           @unique
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  points           Int              @default(1)
  referralCode     String           @unique
  hasJoinedDiscord Boolean          @default(false)
  hasEarlyAccess   Boolean          @default(false)
  grantedAccessAt  DateTime?
  grantedAccessBy  String?
  grantedByUser    User?            @relation("AccessGranter", fields: [grantedAccessBy], references: [id], onDelete: SetNull)
  referredById     String?
  referredBy       WaitlistEntry?   @relation("Referrals", fields: [referredById], references: [id])
  referrals        WaitlistEntry[]  @relation("Referrals")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([userId])
  @@index([referralCode])
  @@index([points, createdAt])
  @@index([hasEarlyAccess])
  @@index([grantedAccessBy])
}

// MCP Authorization - represents an authorized MCP client
model MCPAuthorization {
  id             String            @id @default(cuid())
  userId         String
  organizationId String
  clientName     String            // e.g., "Claude Desktop", "Kiro IDE"
  clientId       String            @unique // Generated client identifier
  
  // Status
  isActive       Boolean           @default(true)
  lastUsedAt     DateTime?
  
  // Timestamps
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  
  // Relations
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  accessTokens   MCPAccessToken[]
  refreshTokens  MCPRefreshToken[]
  
  @@index([userId])
  @@index([organizationId])
  @@index([clientId])
  @@index([userId, organizationId])
}

// MCP Access Token - short-lived token for API access
model MCPAccessToken {
  id              String           @id @default(cuid())
  authorizationId String
  tokenHash       String           @unique // SHA-256 hash of the token
  
  // Expiration
  expiresAt       DateTime
  
  // Metadata
  ipAddress       String?
  userAgent       String?
  
  // Timestamps
  createdAt       DateTime         @default(now())
  
  // Relations
  authorization   MCPAuthorization @relation(fields: [authorizationId], references: [id], onDelete: Cascade)
  
  @@index([authorizationId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// MCP Refresh Token - long-lived token for obtaining new access tokens
model MCPRefreshToken {
  id              String           @id @default(cuid())
  authorizationId String
  tokenHash       String           @unique // SHA-256 hash of the token
  
  // Status
  revoked         Boolean          @default(false)
  revokedAt       DateTime?
  
  // Expiration
  expiresAt       DateTime
  
  // Metadata
  ipAddress       String?
  userAgent       String?
  
  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  authorization   MCPAuthorization @relation(fields: [authorizationId], references: [id], onDelete: Cascade)
  
  @@index([authorizationId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([revoked])
}

// Rate Limit Entry - tracks rate limit attempts for sliding window algorithm
model RateLimitEntry {
  id        String   @id @default(cuid())
  keyId     String   // Composite key: "type:value"
  keyType   String   // 'user', 'ip', or 'token'
  keyValue  String   // The actual value (userId, IP address, or token hash)
  createdAt DateTime @default(now())
  
  @@index([keyId])
  @@index([keyId, createdAt])
  @@index([createdAt]) // For cleanup queries
}

// ============================================================================
// Digital Pass / Access Control System Models
// ============================================================================

// Card Template (Pass Template)
model CardTemplate {
  id                      String   @id @default(cuid())
  exId                    String   @unique // External ID shown to customers
  organizationId          String
  createdById             String
  name                    String
  platform                Platform
  useCase                 UseCase
  protocol                Protocol
  allowOnMultipleDevices  Boolean  @default(false)
  watchCount              Int?
  iphoneCount             Int?

  // Design
  backgroundColor         String?
  labelColor              String?
  labelSecondaryColor     String?
  backgroundImage         String? // Base64 or URL
  logoImage               String?
  iconImage               String?

  // Support Info
  supportUrl              String?
  supportPhoneNumber      String?
  supportEmail            String?
  privacyPolicyUrl        String?
  termsAndConditionsUrl   String?

  // Status
  publishStatus           PublishStatus @default(DRAFT)
  publishedAt             DateTime?

  // Metadata
  metadata                String? // JSON stored as string

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  organization            Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy               User          @relation("CardTemplateCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  accessPasses            AccessPass[]
  eventLogs               PassEventLog[]
  credentialProfiles      CredentialProfile[]

  @@index([organizationId])
  @@index([createdById])
  @@index([publishStatus])
}

// Access Pass (Digital Key)
model AccessPass {
  id                      String   @id @default(cuid())
  exId                    String   @unique // External ID shown to customers
  cardTemplateId          String
  createdById             String

  // Employee/User Info
  employeeId              String?
  fullName                String
  email                   String?
  phoneNumber             String?
  classification          String? // full_time, contractor, etc.
  title                   String?
  employeePhoto           String? // Base64

  // Access Control Data
  tagId                   String? // 14 hex chars for key diversification
  siteCode                String?
  cardNumber              String?
  fileData                String? // Proprietary hex data

  // Validity
  startDate               DateTime
  expirationDate          DateTime

  // Hotel-specific fields
  memberId                String?
  membershipStatus        String?
  isPassReadyToTransact   Boolean?
  tileData                String? // JSON stored as string
  reservations            String? // JSON stored as string

  // State
  state                   PassState @default(PENDING)

  // Device Info
  devices                 String? // JSON array stored as string

  // Metadata
  metadata                String? // JSON stored as string

  // Installation tracking
  installUrl              String?
  installedAt             DateTime?
  lastUsedAt              DateTime?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  cardTemplate            CardTemplate @relation(fields: [cardTemplateId], references: [id], onDelete: Cascade)
  createdBy               User         @relation("AccessPassCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  eventLogs               PassEventLog[]

  @@index([cardTemplateId])
  @@index([createdById])
  @@index([employeeId])
  @@index([state])
}

// Credential Profile for NFC
model CredentialProfile {
  id                String   @id @default(cuid())
  exId              String   @unique
  cardTemplateId    String
  protocol          Protocol

  // DESFire specific
  desfireAppId      String?
  desfireFileId     String?
  desfireKey        String?

  // Seos specific
  seosEndpoint      String?
  seosCredentialId  String?

  // Smart Tap specific (Google)
  smartTapIssuer    String?
  smartTapClass     String?

  metadata          String? // JSON stored as string
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cardTemplate      CardTemplate @relation(fields: [cardTemplateId], references: [id], onDelete: Cascade)

  @@index([cardTemplateId])
}

// Webhook Configuration
model Webhook {
  id          String   @id @default(cuid())
  organizationId String
  url         String
  events      String   // JSON array stored as string
  isActive    Boolean  @default(true)
  secret      String   // Bearer token for authentication
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organizationId])
}

// Webhook Delivery Tracking
model WebhookDelivery {
  id              String   @id @default(cuid())
  webhookId       String
  eventType       String
  payload         String   // JSON stored as string
  responseStatus  Int?
  responseBody    String?
  attempts        Int      @default(0)
  lastAttemptAt   DateTime?
  deliveredAt     DateTime?
  failedAt        DateTime?
  createdAt       DateTime @default(now())

  webhook         Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([eventType])
}

// Event Log for pass system audit trail
model PassEventLog {
  id              String   @id @default(cuid())
  cardTemplateId  String?
  accessPassId    String?
  eventType       PassEventType
  device          String? // mobile or watch
  metadata        String? // JSON stored as string
  createdAt       DateTime @default(now())

  cardTemplate    CardTemplate? @relation(fields: [cardTemplateId], references: [id], onDelete: SetNull)
  accessPass      AccessPass?   @relation(fields: [accessPassId], references: [id], onDelete: SetNull)

  @@index([cardTemplateId])
  @@index([accessPassId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================================================
// Enums for Digital Pass System
// ============================================================================

enum Platform {
  APPLE
  GOOGLE
}

enum UseCase {
  EMPLOYEE_BADGE
  HOTEL
  RESIDENTIAL
  VEHICLE
}

enum Protocol {
  DESFIRE
  SEOS
  SMART_TAP
}

enum PublishStatus {
  DRAFT
  REVIEW
  PUBLISHED
}

enum PassState {
  PENDING
  ACTIVE
  SUSPENDED
  UNLINKED
  DELETED
  EXPIRED
}

enum PassEventType {
  // Access Pass Events
  ACCESS_PASS_ISSUED
  ACCESS_PASS_ACTIVATED
  ACCESS_PASS_UPDATED
  ACCESS_PASS_SUSPENDED
  ACCESS_PASS_RESUMED
  ACCESS_PASS_UNLINKED
  ACCESS_PASS_DELETED
  ACCESS_PASS_EXPIRED

  // Card Template Events
  CARD_TEMPLATE_CREATED
  CARD_TEMPLATE_UPDATED
  CARD_TEMPLATE_REQUESTED_PUBLISHING
  CARD_TEMPLATE_PUBLISHED

  // Landing Page Events (future)
  LANDING_PAGE_CREATED
  LANDING_PAGE_UPDATED
  LANDING_PAGE_ATTACHED_TO_TEMPLATE

  // Credential Profile Events
  CREDENTIAL_PROFILE_CREATED
  CREDENTIAL_PROFILE_ATTACHED_TO_TEMPLATE
}
