[1mdiff --git a/apps/app/app/utils/oidc-discovery.server.ts b/apps/app/app/utils/oidc-discovery.server.ts[m
[1mindex e6fc9d65..7a35804c 100644[m
[1m--- a/apps/app/app/utils/oidc-discovery.server.ts[m
[1m+++ b/apps/app/app/utils/oidc-discovery.server.ts[m
[36m@@ -6,206 +6,206 @@[m
 import { ssoCache } from './sso-cache.server.ts'[m
 import { ssoConnectionPool } from './sso-connection-pool.server.ts'[m
 import {[m
[31m-	validateOIDCIssuerUrl,[m
[31m-	validateEndpointUrl,[m
[32m+[m[32m    validateOIDCIssuerUrl,[m
[32m+[m[32m    validateEndpointUrl,[m
 } from './url-validation.server.ts'[m
 [m
 export interface OIDCDiscoveryDocument {[m
[31m-	issuer: string[m
[31m-	authorization_endpoint: string[m
[31m-	token_endpoint: string[m
[31m-	userinfo_endpoint?: string[m
[31m-	revocation_endpoint?: string[m
[31m-	jwks_uri?: string[m
[31m-	scopes_supported?: string[][m
[31m-	response_types_supported?: string[][m
[31m-	grant_types_supported?: string[][m
[31m-	subject_types_supported?: string[][m
[31m-	id_token_signing_alg_values_supported?: string[][m
[31m-	code_challenge_methods_supported?: string[][m
[31m-	[key: string]: any[m
[32m+[m[32m    issuer: string[m
[32m+[m[32m    authorization_endpoint: string[m
[32m+[m[32m    token_endpoint: string[m
[32m+[m[32m    userinfo_endpoint?: string[m
[32m+[m[32m    revocation_endpoint?: string[m
[32m+[m[32m    jwks_uri?: string[m
[32m+[m[32m    scopes_supported?: string[][m
[32m+[m[32m    response_types_supported?: string[][m
[32m+[m[32m    grant_types_supported?: string[][m
[32m+[m[32m    subject_types_supported?: string[][m
[32m+[m[32m    id_token_signing_alg_values_supported?: string[][m
[32m+[m[32m    code_challenge_methods_supported?: string[][m
[32m+[m[32m    [key: string]: any[m
 }[m
 [m
 export interface EndpointConfiguration {[m
[31m-	authorizationUrl: string[m
[31m-	tokenUrl: string[m
[31m-	userinfoUrl?: string[m
[31m-	revocationUrl?: string[m
[31m-	jwksUrl?: string[m
[32m+[m[32m    authorizationUrl: string[m
[32m+[m[32m    tokenUrl: string[m
[32m+[m[32m    userinfoUrl?: string[m
[32m+[m[32m    revocationUrl?: string[m
[32m+[m[32m    jwksUrl?: string[m
 }[m
 [m
 export interface DiscoveryResult {[m
[31m-	success: boolean[m
[31m-	endpoints?: EndpointConfiguration[m
[31m-	discoveryDocument?: OIDCDiscoveryDocument[m
[31m-	error?: string[m
[32m+[m[32m    success: boolean[m
[32m+[m[32m    endpoints?: EndpointConfiguration[m
[32m+[m[32m    discoveryDocument?: OIDCDiscoveryDocument[m
[32m+[m[32m    error?: string[m
 }[m
 [m
 export interface EndpointValidationResult {[m
[31m-	valid: boolean[m
[31m-	errors: string[][m
[31m-	warnings: string[][m
[32m+[m[32m    valid: boolean[m
[32m+[m[32m    errors: string[][m
[32m+[m[32m    warnings: string[][m
 }[m
 [m
 /**[m
  * Discover OIDC endpoints from .well-known/openid-configuration[m
  */[m
 export async function discoverOIDCEndpoints([m
[31m-	issuerUrl: string,[m
[32m+[m[32m    issuerUrl: string,[m
 ): Promise<DiscoveryResult> {[m
[31m-	// Log only in development mode to avoid information disclosure[m
[31m-	if (process.env.NODE_ENV === 'development') {[m
[31m-		console.log('Starting OIDC discovery')[m
[31m-	}[m
[31m-[m
[31m-	try {[m
[31m-		// SECURITY: Validate issuer URL against SSRF attacks[m
[31m-		const urlValidation = validateOIDCIssuerUrl(issuerUrl)[m
[31m-		if (!urlValidation.valid) {[m
[31m-			return {[m
[31m-				success: false,[m
[31m-				error: `Invalid issuer URL: ${urlValidation.error}`,[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		const normalizedIssuer = urlValidation.normalizedUrl![m
[31m-[m
[31m-		// Check cache first[m
[31m-		const cachedEndpoints = ssoCache.getEndpoints(normalizedIssuer)[m
[31m-		if (cachedEndpoints) {[m
[31m-			return {[m
[31m-				success: true,[m
[31m-				endpoints: cachedEndpoints,[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		// IMMEDIATE FALLBACK FOR DEVELOPMENT[m
[31m-		if (process.env.NODE_ENV === 'development') {[m
[31m-			if (normalizedIssuer.includes('okta.com')) {[m
[31m-				const fallbackEndpoints: EndpointConfiguration = {[m
[31m-					authorizationUrl: `${normalizedIssuer}/v1/authorize`,[m
[31m-					tokenUrl: `${normalizedIssuer}/v1/token`,[m
[31m-					userinfoUrl: `${normalizedIssuer}/v1/userinfo`,[m
[31m-					revocationUrl: `${normalizedIssuer}/v1/revoke`,[m
[31m-					jwksUrl: `${normalizedIssuer}/v1/keys`,[m
[31m-				}[m
[31m-[m
[31m-				return {[m
[31m-					success: true,[m
[31m-					endpoints: fallbackEndpoints,[m
[31m-					discoveryDocument: {[m
[31m-						issuer: normalizedIssuer,[m
[31m-						authorization_endpoint: fallbackEndpoints.authorizationUrl,[m
[31m-						token_endpoint: fallbackEndpoints.tokenUrl,[m
[31m-						userinfo_endpoint: fallbackEndpoints.userinfoUrl,[m
[31m-						revocation_endpoint: fallbackEndpoints.revocationUrl,[m
[31m-						jwks_uri: fallbackEndpoints.jwksUrl,[m
[31m-					} as OIDCDiscoveryDocument,[m
[31m-				}[m
[31m-			}[m
[31m-[m
[31m-			if (normalizedIssuer === 'https://accounts.google.com') {[m
[31m-				const fallbackEndpoints: EndpointConfiguration = {[m
[31m-					authorizationUrl: 'https://accounts.google.com/o/oauth2/v2/auth',[m
[31m-					tokenUrl: 'https://oauth2.googleapis.com/token',[m
[31m-					userinfoUrl: 'https://openidconnect.googleapis.com/v1/userinfo',[m
[31m-					revocationUrl: 'https://oauth2.googleapis.com/revoke',[m
[31m-					jwksUrl: 'https://www.googleapis.com/oauth2/v3/certs',[m
[31m-				}[m
[31m-[m
[31m-				return {[m
[31m-					success: true,[m
[31m-					endpoints: fallbackEndpoints,[m
[31m-					discoveryDocument: {[m
[31m-						issuer: 'https://accounts.google.com',[m
[31m-						authorization_endpoint: fallbackEndpoints.authorizationUrl,[m
[31m-						token_endpoint: fallbackEndpoints.tokenUrl,[m
[31m-						userinfo_endpoint: fallbackEndpoints.userinfoUrl,[m
[31m-						revocation_endpoint: fallbackEndpoints.revocationUrl,[m
[31m-						jwks_uri: fallbackEndpoints.jwksUrl,[m
[31m-					} as OIDCDiscoveryDocument,[m
[31m-				}[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		// SECURITY: Validate discovery URL before making request[m
[31m-		const discoveryUrl = `${normalizedIssuer}/.well-known/openid-configuration`[m
[31m-		const discoveryUrlValidation = validateEndpointUrl(discoveryUrl)[m
[31m-		if (!discoveryUrlValidation.valid) {[m
[31m-			return {[m
[31m-				success: false,[m
[31m-				error: `Invalid discovery URL: ${discoveryUrlValidation.error}`,[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		const response = await ssoConnectionPool.request(discoveryUrl, {[m
[31m-			method: 'GET',[m
[31m-			headers: {[m
[31m-				Accept: 'application/json',[m
[31m-				'User-Agent': 'Epic-Notes-SSO/1.0',[m
[31m-			},[m
[31m-		})[m
[31m-[m
[31m-		if (!response.ok) {[m
[31m-			return {[m
[31m-				success: false,[m
[31m-				error: `HTTP ${response.status}: ${response.statusText}`,[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		const contentType = response.headers.get('content-type')[m
[31m-		if (!contentType?.includes('application/json')) {[m
[31m-			return {[m
[31m-				success: false,[m
[31m-				error: `Invalid content type: expected application/json, got ${contentType}`,[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		const discoveryDoc = (await response.json()) as OIDCDiscoveryDocument[m
[31m-[m
[31m-		// Validate the discovery document[m
[31m-		const validation = validateDiscoveryDocument(discoveryDoc, normalizedIssuer)[m
[31m-		if (!validation.valid) {[m
[31m-			return {[m
[31m-				success: false,[m
[31m-				error: `Invalid OIDC discovery document: ${validation.errors.join(', ')}`,[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		const endpoints: EndpointConfiguration = {[m
[31m-			authorizationUrl: discoveryDoc.authorization_endpoint,[m
[31m-			tokenUrl: discoveryDoc.token_endpoint,[m
[31m-			userinfoUrl: discoveryDoc.userinfo_endpoint,[m
[31m-			revocationUrl: discoveryDoc.revocation_endpoint,[m
[31m-			jwksUrl: discoveryDoc.jwks_uri,[m
[31m-		}[m
[31m-[m
[31m-		// Cache the discovered endpoints[m
[31m-		ssoCache.setEndpoints(normalizedIssuer, endpoints)[m
[31m-[m
[31m-		return {[m
[31m-			success: true,[m
[31m-			endpoints,[m
[31m-			discoveryDocument: discoveryDoc,[m
[31m-		}[m
[31m-	} catch (error) {[m
[31m-		if (error instanceof Error) {[m
[31m-			if (error.name === 'AbortError') {[m
[31m-				return {[m
[31m-					success: false,[m
[31m-					error: 'Request timeout: OIDC discovery took too long',[m
[31m-				}[m
[31m-			}[m
[31m-			return {[m
[31m-				success: false,[m
[31m-				error: `Network error: ${error.message}`,[m
[31m-			}[m
[31m-		}[m
[31m-		return {[m
[31m-			success: false,[m
[31m-			error: 'Unknown error occurred during OIDC discovery',[m
[31m-		}[m
[31m-	}[m
[32m+[m[32m    // Log only in development mode to avoid information disclosure[m
[32m+[m[32m    if (process.env.NODE_ENV === 'development') {[m
[32m+[m[32m        console.log('Starting OIDC discovery')[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m        // SECURITY: Validate issuer URL against SSRF attacks[m
[32m+[m[32m        const urlValidation = validateOIDCIssuerUrl(issuerUrl)[m
[32m+[m[32m        if (!urlValidation.valid) {[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                error: `Invalid issuer URL: ${urlValidation.error}`,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const normalizedIssuer = urlValidation.normalizedUrl![m
[32m+[m
[32m+[m[32m        // Check cache first[m
[32m+[m[32m        const cachedEndpoints = ssoCache.getEndpoints(normalizedIssuer)[m
[32m+[m[32m        if (cachedEndpoints) {[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: true,[m
[32m+[m[32m                endpoints: cachedEndpoints,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // IMMEDIATE FALLBACK FOR DEVELOPMENT[m
[32m+[m[32m        if (process.env.NODE_ENV === 'development') {[m
[32m+[m[32m            if (normalizedIssuer.includes('okta.com')) {[m
[32m+[m[32m                const fallbackEndpoints: EndpointConfiguration = {[m
[32m+[m[32m                    authorizationUrl: `${normalizedIssuer}/v1/authorize`,[m
[32m+[m[32m                    tokenUrl: `${normalizedIssuer}/v1/token`,[m
[32m+[m[32m                    userinfoUrl: `${normalizedIssuer}/v1/userinfo`,[m
[32m+[m[32m                    revocationUrl: `${normalizedIssuer}/v1/revoke`,[m
[32m+[m[32m                    jwksUrl: `${normalizedIssuer}/v1/keys`,[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                return {[m
[32m+[m[32m                    success: true,[m
[32m+[m[32m                    endpoints: fallbackEndpoints,[m
[32m+[m[32m                    discoveryDocument: {[m
[32m+[m[32m                        issuer: normalizedIssuer,[m
[32m+[m[32m                        authorization_endpoint: fallbackEndpoints.authorizationUrl,[m
[32m+[m[32m                        token_endpoint: fallbackEndpoints.tokenUrl,[m
[32m+[m[32m                        userinfo_endpoint: fallbackEndpoints.userinfoUrl,[m
[32m+[m[32m                        revocation_endpoint: fallbackEndpoints.revocationUrl,[m
[32m+[m[32m                        jwks_uri: fallbackEndpoints.jwksUrl,[m
[32m+[m[32m                    } as OIDCDiscoveryDocument,[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (normalizedIssuer === 'https://accounts.google.com') {[m
[32m+[m[32m                const fallbackEndpoints: EndpointConfiguration = {[m
[32m+[m[32m                    authorizationUrl: 'https://accounts.google.com/o/oauth2/v2/auth',[m
[32m+[m[32m                    tokenUrl: 'https://oauth2.googleapis.com/token',[m
[32m+[m[32m                    userinfoUrl: 'https://openidconnect.googleapis.com/v1/userinfo',[m
[32m+[m[32m                    revocationUrl: 'https://oauth2.googleapis.com/revoke',[m
[32m+[m[32m                    jwksUrl: 'https://www.googleapis.com/oauth2/v3/certs',[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                return {[m
[32m+[m[32m                    success: true,[m
[32m+[m[32m                    endpoints: fallbackEndpoints,[m
[32m+[m[32m                    discoveryDocument: {[m
[32m+[m[32m                        issuer: 'https://accounts.google.com',[m
[32m+[m[32m                        authorization_endpoint: fallbackEndpoints.authorizationUrl,[m
[32m+[m[32m                        token_endpoint: fallbackEndpoints.tokenUrl,[m
[32m+[m[32m                        userinfo_endpoint: fallbackEndpoints.userinfoUrl,[m
[32m+[m[32m                        revocation_endpoint: fallbackEndpoints.revocationUrl,[m
[32m+[m[32m                        jwks_uri: fallbackEndpoints.jwksUrl,[m
[32m+[m[32m                    } as OIDCDiscoveryDocument,[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // SECURITY: Validate discovery URL before making request[m
[32m+[m[32m        const discoveryUrl = `${normalizedIssuer}/.well-known/openid-configuration`[m
[32m+[m[32m        const discoveryUrlValidation = validateEndpointUrl(discoveryUrl)[m
[32m+[m[32m        if (!discoveryUrlValidation.valid) {[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                error: `Invalid discovery URL: ${discoveryUrlValidation.error}`,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const response = await ssoConnectionPool.request(discoveryUrl, {[m
[32m+[m[32m            method: 'GET',[m
[32m+[m[32m            headers: {[m
[32m+[m[32m                Accept: 'application/json',[m
[32m+[m[32m                'User-Agent': 'Epic-Notes-SSO/1.0',[m
[32m+[m[32m            },[m
[32m+[m[32m        })[m
[32m+[m
[32m+[m[32m        if (!response.ok) {[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                error: `HTTP ${response.status}: ${response.statusText}`,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const contentType = response.headers.get('content-type')[m
[32m+[m[32m        if (!contentType?.includes('application/json')) {[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                error: `Invalid content type: expected application/json, got ${contentType}`,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const discoveryDoc = (await response.json()) as OIDCDiscoveryDocument[m
[32m+[m
[32m+[m[32m        // Validate the discovery document[m
[32m+[m[32m        const validation = validateDiscoveryDocument(discoveryDoc, normalizedIssuer)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                error: `Invalid OIDC discovery document: ${validation.errors.join(', ')}`,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const endpoints: EndpointConfiguration = {[m
[32m+[m[32m            authorizationUrl: discoveryDoc.authorization_endpoint,[m
[32m+[m[32m            tokenUrl: discoveryDoc.token_endpoint,[m
[32m+[m[32m            userinfoUrl: discoveryDoc.userinfo_endpoint,[m
[32m+[m[32m            revocationUrl: discoveryDoc.revocation_endpoint,[m
[32m+[m[32m            jwksUrl: discoveryDoc.jwks_uri,[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Cache the discovered endpoints[m
[32m+[m[32m        ssoCache.setEndpoints(normalizedIssuer, endpoints)[m
[32m+[m
[32m+[m[32m        return {[m
[32m+[m[32m            success: true,[m
[32m+[m[32m            endpoints,[m
[32m+[m[32m            discoveryDocument: discoveryDoc,[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (error) {[m
[32m+[m[32m        if (error instanceof Error) {[m
[32m+[m[32m            if (error.name === 'AbortError') {[m
[32m+[m[32m                return {[m
[32m+[m[32m                    success: false,[m
[32m+[m[32m                    error: 'Request timeout: OIDC discovery took too long',[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m            return {[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                error: `Network error: ${error.message}`,[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m        return {[m
[32m+[m[32m            success: false,[m
[32m+[m[32m            error: 'Unknown error occurred during OIDC discovery',[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
 }[m
 [m
 /**[m
[36m@@ -213,95 +213,95 @@[m [mexport async function discoverOIDCEndpoints([m
  * SECURITY: Also validates URLs against SSRF attacks[m
  */[m
 export function validateDiscoveryDocument([m
[31m-	doc: any,[m
[31m-	expectedIssuer: string,[m
[32m+[m[32m    doc: any,[m
[32m+[m[32m    expectedIssuer: string,[m
 ): EndpointValidationResult {[m
[31m-	const errors: string[] = [][m
[31m-	const warnings: string[] = [][m
[31m-[m
[31m-	// Required fields according to OIDC Discovery spec[m
[31m-	if (!doc.issuer) {[m
[31m-		errors.push('Missing required field: issuer')[m
[31m-	} else if (doc.issuer !== expectedIssuer) {[m
[31m-		errors.push([m
[31m-			`Issuer mismatch: expected ${expectedIssuer}, got ${doc.issuer}`,[m
[31m-		)[m
[31m-	}[m
[31m-[m
[31m-	// SECURITY: Validate authorization_endpoint against SSRF[m
[31m-	if (!doc.authorization_endpoint) {[m
[31m-		errors.push('Missing required field: authorization_endpoint')[m
[31m-	} else {[m
[31m-		const validation = validateEndpointUrl(doc.authorization_endpoint)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push([m
[31m-				`Invalid authorization_endpoint URL: ${validation.error}`,[m
[31m-			)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// SECURITY: Validate token_endpoint against SSRF[m
[31m-	if (!doc.token_endpoint) {[m
[31m-		errors.push('Missing required field: token_endpoint')[m
[31m-	} else {[m
[31m-		const validation = validateEndpointUrl(doc.token_endpoint)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid token_endpoint URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// SECURITY: Validate jwks_uri against SSRF[m
[31m-	if (!doc.jwks_uri) {[m
[31m-		warnings.push('Missing jwks_uri (recommended for token validation)')[m
[31m-	} else {[m
[31m-		const validation = validateEndpointUrl(doc.jwks_uri)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid jwks_uri URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// SECURITY: Validate optional endpoints against SSRF[m
[31m-	if (doc.userinfo_endpoint) {[m
[31m-		const validation = validateEndpointUrl(doc.userinfo_endpoint)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid userinfo_endpoint URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	if (doc.revocation_endpoint) {[m
[31m-		const validation = validateEndpointUrl(doc.revocation_endpoint)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid revocation_endpoint URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// Validate supported features[m
[31m-	if ([m
[31m-		doc.response_types_supported &&[m
[31m-		!doc.response_types_supported.includes('code')[m
[31m-	) {[m
[31m-		warnings.push('Authorization code flow not explicitly supported')[m
[31m-	}[m
[31m-[m
[31m-	if ([m
[31m-		doc.grant_types_supported &&[m
[31m-		!doc.grant_types_supported.includes('authorization_code')[m
[31m-	) {[m
[31m-		warnings.push('Authorization code grant type not explicitly supported')[m
[31m-	}[m
[31m-[m
[31m-	if ([m
[31m-		doc.code_challenge_methods_supported &&[m
[31m-		!doc.code_challenge_methods_supported.includes('S256')[m
[31m-	) {[m
[31m-		warnings.push('PKCE with S256 not supported (security recommendation)')[m
[31m-	}[m
[31m-[m
[31m-	return {[m
[31m-		valid: errors.length === 0,[m
[31m-		errors,[m
[31m-		warnings,[m
[31m-	}[m
[32m+[m[32m    const errors: string[] = [][m
[32m+[m[32m    const warnings: string[] = [][m
[32m+[m
[32m+[m[32m    // Required fields according to OIDC Discovery spec[m
[32m+[m[32m    if (!doc.issuer) {[m
[32m+[m[32m        errors.push('Missing required field: issuer')[m
[32m+[m[32m    } else if (doc.issuer !== expectedIssuer) {[m
[32m+[m[32m        errors.push([m
[32m+[m[32m            `Issuer mismatch: expected ${expectedIssuer}, got ${doc.issuer}`,[m
[32m+[m[32m        )[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // SECURITY: Validate authorization_endpoint against SSRF[m
[32m+[m[32m    if (!doc.authorization_endpoint) {[m
[32m+[m[32m        errors.push('Missing required field: authorization_endpoint')[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const validation = validateEndpointUrl(doc.authorization_endpoint)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push([m
[32m+[m[32m                `Invalid authorization_endpoint URL: ${validation.error}`,[m
[32m+[m[32m            )[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // SECURITY: Validate token_endpoint against SSRF[m
[32m+[m[32m    if (!doc.token_endpoint) {[m
[32m+[m[32m        errors.push('Missing required field: token_endpoint')[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const validation = validateEndpointUrl(doc.token_endpoint)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid token_endpoint URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // SECURITY: Validate jwks_uri against SSRF[m
[32m+[m[32m    if (!doc.jwks_uri) {[m
[32m+[m[32m        warnings.push('Missing jwks_uri (recommended for token validation)')[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const validation = validateEndpointUrl(doc.jwks_uri)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid jwks_uri URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // SECURITY: Validate optional endpoints against SSRF[m
[32m+[m[32m    if (doc.userinfo_endpoint) {[m
[32m+[m[32m        const validation = validateEndpointUrl(doc.userinfo_endpoint)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid userinfo_endpoint URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (doc.revocation_endpoint) {[m
[32m+[m[32m        const validation = validateEndpointUrl(doc.revocation_endpoint)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid revocation_endpoint URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Validate supported features[m
[32m+[m[32m    if ([m
[32m+[m[32m        doc.response_types_supported &&[m
[32m+[m[32m        !doc.response_types_supported.includes('code')[m
[32m+[m[32m    ) {[m
[32m+[m[32m        warnings.push('Authorization code flow not explicitly supported')[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if ([m
[32m+[m[32m        doc.grant_types_supported &&[m
[32m+[m[32m        !doc.grant_types_supported.includes('authorization_code')[m
[32m+[m[32m    ) {[m
[32m+[m[32m        warnings.push('Authorization code grant type not explicitly supported')[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if ([m
[32m+[m[32m        doc.code_challenge_methods_supported &&[m
[32m+[m[32m        !doc.code_challenge_methods_supported.includes('S256')[m
[32m+[m[32m    ) {[m
[32m+[m[32m        warnings.push('PKCE with S256 not supported (security recommendation)')[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        valid: errors.length === 0,[m
[32m+[m[32m        errors,[m
[32m+[m[32m        warnings,[m
[32m+[m[32m    }[m
 }[m
 [m
 /**[m
[36m@@ -309,259 +309,259 @@[m [mexport function validateDiscoveryDocument([m
  * SECURITY: Also validates URLs against SSRF attacks[m
  */[m
 export function validateManualEndpoints([m
[31m-	endpoints: Partial<EndpointConfiguration>,[m
[32m+[m[32m    endpoints: Partial<EndpointConfiguration>,[m
 ): EndpointValidationResult {[m
[31m-	const errors: string[] = [][m
[31m-	const warnings: string[] = [][m
[31m-[m
[31m-	// SECURITY: Validate required endpoints against SSRF[m
[31m-	if (!endpoints.authorizationUrl) {[m
[31m-		errors.push('Authorization URL is required')[m
[31m-	} else {[m
[31m-		const validation = validateEndpointUrl(endpoints.authorizationUrl)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid authorization URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	if (!endpoints.tokenUrl) {[m
[31m-		errors.push('Token URL is required')[m
[31m-	} else {[m
[31m-		const validation = validateEndpointUrl(endpoints.tokenUrl)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid token URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// SECURITY: Validate optional endpoints against SSRF[m
[31m-	if (endpoints.userinfoUrl) {[m
[31m-		const validation = validateEndpointUrl(endpoints.userinfoUrl)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid userinfo URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	if (endpoints.revocationUrl) {[m
[31m-		const validation = validateEndpointUrl(endpoints.revocationUrl)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid revocation URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	if (endpoints.jwksUrl) {[m
[31m-		const validation = validateEndpointUrl(endpoints.jwksUrl)[m
[31m-		if (!validation.valid) {[m
[31m-			errors.push(`Invalid JWKS URL: ${validation.error}`)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// Warnings for missing optional but recommended endpoints[m
[31m-	if (!endpoints.userinfoUrl) {[m
[31m-		warnings.push([m
[31m-			'UserInfo endpoint not configured (may limit user attribute retrieval)',[m
[31m-		)[m
[31m-	}[m
[31m-[m
[31m-	if (!endpoints.revocationUrl) {[m
[31m-		warnings.push([m
[31m-			'Token revocation endpoint not configured (may impact logout security)',[m
[31m-		)[m
[31m-	}[m
[31m-[m
[31m-	return {[m
[31m-		valid: errors.length === 0,[m
[31m-		errors,[m
[31m-		warnings,[m
[31m-	}[m
[32m+[m[32m    const errors: string[] = [][m
[32m+[m[32m    const warnings: string[] = [][m
[32m+[m
[32m+[m[32m    // SECURITY: Validate required endpoints against SSRF[m
[32m+[m[32m    if (!endpoints.authorizationUrl) {[m
[32m+[m[32m        errors.push('Authorization URL is required')[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const validation = validateEndpointUrl(endpoints.authorizationUrl)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid authorization URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (!endpoints.tokenUrl) {[m
[32m+[m[32m        errors.push('Token URL is required')[m
[32m+[m[32m    } else {[m
[32m+[m[32m        const validation = validateEndpointUrl(endpoints.tokenUrl)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid token URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // SECURITY: Validate optional endpoints against SSRF[m
[32m+[m[32m    if (endpoints.userinfoUrl) {[m
[32m+[m[32m        const validation = validateEndpointUrl(endpoints.userinfoUrl)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid userinfo URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (endpoints.revocationUrl) {[m
[32m+[m[32m        const validation = validateEndpointUrl(endpoints.revocationUrl)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid revocation URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (endpoints.jwksUrl) {[m
[32m+[m[32m        const validation = validateEndpointUrl(endpoints.jwksUrl)[m
[32m+[m[32m        if (!validation.valid) {[m
[32m+[m[32m            errors.push(`Invalid JWKS URL: ${validation.error}`)[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Warnings for missing optional but recommended endpoints[m
[32m+[m[32m    if (!endpoints.userinfoUrl) {[m
[32m+[m[32m        warnings.push([m
[32m+[m[32m            'UserInfo endpoint not configured (may limit user attribute retrieval)',[m
[32m+[m[32m        )[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (!endpoints.revocationUrl) {[m
[32m+[m[32m        warnings.push([m
[32m+[m[32m            'Token revocation endpoint not configured (may impact logout security)',[m
[32m+[m[32m        )[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m        valid: errors.length === 0,[m
[32m+[m[32m        errors,[m
[32m+[m[32m        warnings,[m
[32m+[m[32m    }[m
 }[m
 [m
 /**[m
  * Resolve endpoints with fallback from auto-discovery to manual configuration[m
  */[m
 export async function resolveEndpoints([m
[31m-	issuerUrl: string,[m
[31m-	manualEndpoints?: Partial<EndpointConfiguration>,[m
[31m-	preferAutoDiscovery: boolean = true,[m
[32m+[m[32m    issuerUrl: string,[m
[32m+[m[32m    manualEndpoints?: Partial<EndpointConfiguration>,[m
[32m+[m[32m    preferAutoDiscovery: boolean = true,[m
 ): Promise<DiscoveryResult> {[m
[31m-	if (preferAutoDiscovery) {[m
[31m-		// Try auto-discovery first[m
[31m-		const discoveryResult = await discoverOIDCEndpoints(issuerUrl)[m
[31m-		if (discoveryResult.success) {[m
[31m-			return discoveryResult[m
[31m-		}[m
[31m-[m
[31m-		// Fall back to manual configuration if discovery fails[m
[31m-		if (manualEndpoints) {[m
[31m-			const validation = validateManualEndpoints(manualEndpoints)[m
[31m-			if (validation.valid) {[m
[31m-				return {[m
[31m-					success: true,[m
[31m-					endpoints: manualEndpoints as EndpointConfiguration,[m
[31m-				}[m
[31m-			} else {[m
[31m-				return {[m
[31m-					success: false,[m
[31m-					error: `Manual endpoint validation failed: ${validation.errors.join(', ')}`,[m
[31m-				}[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		return discoveryResult // Return original discovery error[m
[31m-	} else {[m
[31m-		// Use manual configuration first[m
[31m-		if (manualEndpoints) {[m
[31m-			const validation = validateManualEndpoints(manualEndpoints)[m
[31m-			if (validation.valid) {[m
[31m-				return {[m
[31m-					success: true,[m
[31m-					endpoints: manualEndpoints as EndpointConfiguration,[m
[31m-				}[m
[31m-			}[m
[31m-		}[m
[31m-[m
[31m-		// Fall back to auto-discovery[m
[31m-		return discoverOIDCEndpoints(issuerUrl)[m
[31m-	}[m
[32m+[m[32m    if (preferAutoDiscovery) {[m
[32m+[m[32m        // Try auto-discovery first[m
[32m+[m[32m        const discoveryResult = await discoverOIDCEndpoints(issuerUrl)[m
[32m+[m[32m        if (discoveryResult.success) {[m
[32m+[m[32m            return discoveryResult[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Fall back to manual configuration if discovery fails[m
[32m+[m[32m        if (manualEndpoints) {[m
[32m+[m[32m            const validation = validateManualEndpoints(manualEndpoints)[m
[32m+[m[32m            if (validation.valid) {[m
[32m+[m[32m                return {[m
[32m+[m[32m                    success: true,[m
[32m+[m[32m                    endpoints: manualEndpoints as EndpointConfiguration,[m
[32m+[m[32m                }[m
[32m+[m[32m            } else {[m
[32m+[m[32m                return {[m
[32m+[m[32m                    success: false,[m
[32m+[m[32m                    error: `Manual endpoint validation failed: ${validation.errors.join(', ')}`,[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return discoveryResult // Return original discovery error[m
[32m+[m[32m    } else {[m
[32m+[m[32m        // Use manual configuration first[m
[32m+[m[32m        if (manualEndpoints) {[m
[32m+[m[32m            const validation = validateManualEndpoints(manualEndpoints)[m
[32m+[m[32m            if (validation.valid) {[m
[32m+[m[32m                return {[m
[32m+[m[32m                    success: true,[m
[32m+[m[32m                    endpoints: manualEndpoints as EndpointConfiguration,[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // Fall back to auto-discovery[m
[32m+[m[32m        return discoverOIDCEndpoints(issuerUrl)[m
[32m+[m[32m    }[m
 }[m
 [m
 /**[m
  * Test endpoint connectivity[m
  */[m
 export async function testEndpointConnectivity([m
[31m-	endpoints: EndpointConfiguration,[m
[32m+[m[32m    endpoints: EndpointConfiguration,[m
 ): Promise<{[m
[31m-	authorizationEndpoint: boolean[m
[31m-	tokenEndpoint: boolean[m
[31m-	userinfoEndpoint?: boolean[m
[31m-	revocationEndpoint?: boolean[m
[31m-	errors: string[][m
[32m+[m[32m    authorizationEndpoint: boolean[m
[32m+[m[32m    tokenEndpoint: boolean[m
[32m+[m[32m    userinfoEndpoint?: boolean[m
[32m+[m[32m    revocationEndpoint?: boolean[m
[32m+[m[32m    errors: string[][m
 }> {[m
[31m-	const results = {[m
[31m-		authorizationEndpoint: false,[m
[31m-		tokenEndpoint: false,[m
[31m-		userinfoEndpoint: undefined as boolean | undefined,[m
[31m-		revocationEndpoint: undefined as boolean | undefined,[m
[31m-		errors: [] as string[],[m
[31m-	}[m
[31m-[m
[31m-	// Test authorization endpoint (should return 400 for missing parameters)[m
[31m-	try {[m
[31m-		const authResponse = await ssoConnectionPool.request([m
[31m-			endpoints.authorizationUrl,[m
[31m-			{[m
[31m-				method: 'GET',[m
[31m-			},[m
[31m-		)[m
[31m-		// 400 is expected for missing OAuth parameters[m
[31m-		results.authorizationEndpoint =[m
[31m-			authResponse.status === 400 || authResponse.status === 302[m
[31m-		if (!results.authorizationEndpoint) {[m
[31m-			results.errors.push([m
[31m-				`Authorization endpoint returned unexpected status: ${authResponse.status}`,[m
[31m-			)[m
[31m-		}[m
[31m-	} catch (error) {[m
[31m-		results.errors.push([m
[31m-			`Authorization endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[31m-		)[m
[31m-	}[m
[31m-[m
[31m-	// Test token endpoint (should return 400 for missing parameters)[m
[31m-	try {[m
[31m-		const tokenResponse = await ssoConnectionPool.request(endpoints.tokenUrl, {[m
[31m-			method: 'POST',[m
[31m-			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },[m
[31m-			body: '',[m
[31m-		})[m
[31m-		// 400 is expected for missing OAuth parameters[m
[31m-		results.tokenEndpoint = tokenResponse.status === 400[m
[31m-		if (!results.tokenEndpoint) {[m
[31m-			results.errors.push([m
[31m-				`Token endpoint returned unexpected status: ${tokenResponse.status}`,[m
[31m-			)[m
[31m-		}[m
[31m-	} catch (error) {[m
[31m-		results.errors.push([m
[31m-			`Token endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[31m-		)[m
[31m-	}[m
[31m-[m
[31m-	// Test userinfo endpoint if provided (should return 401 for missing token)[m
[31m-	if (endpoints.userinfoUrl) {[m
[31m-		try {[m
[31m-			const userinfoResponse = await ssoConnectionPool.request([m
[31m-				endpoints.userinfoUrl,[m
[31m-				{[m
[31m-					method: 'GET',[m
[31m-				},[m
[31m-			)[m
[31m-			// 401 is expected for missing authorization header[m
[31m-			results.userinfoEndpoint = userinfoResponse.status === 401[m
[31m-			if (!results.userinfoEndpoint) {[m
[31m-				results.errors.push([m
[31m-					`UserInfo endpoint returned unexpected status: ${userinfoResponse.status}`,[m
[31m-				)[m
[31m-			}[m
[31m-		} catch (error) {[m
[31m-			results.userinfoEndpoint = false[m
[31m-			results.errors.push([m
[31m-				`UserInfo endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[31m-			)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	// Test revocation endpoint if provided (should return 400 for missing parameters)[m
[31m-	if (endpoints.revocationUrl) {[m
[31m-		try {[m
[31m-			const revocationResponse = await ssoConnectionPool.request([m
[31m-				endpoints.revocationUrl,[m
[31m-				{[m
[31m-					method: 'POST',[m
[31m-					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },[m
[31m-					body: '',[m
[31m-				},[m
[31m-			)[m
[31m-			// 400 is expected for missing parameters[m
[31m-			results.revocationEndpoint = revocationResponse.status === 400[m
[31m-			if (!results.revocationEndpoint) {[m
[31m-				results.errors.push([m
[31m-					`Revocation endpoint returned unexpected status: ${revocationResponse.status}`,[m
[31m-				)[m
[31m-			}[m
[31m-		} catch (error) {[m
[31m-			results.revocationEndpoint = false[m
[31m-			results.errors.push([m
[31m-				`Revocation endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[31m-			)[m
[31m-		}[m
[31m-	}[m
[31m-[m
[31m-	return results[m
[32m+[m[32m    const results = {[m
[32m+[m[32m        authorizationEndpoint: false,[m
[32m+[m[32m        tokenEndpoint: false,[m
[32m+[m[32m        userinfoEndpoint: undefined as boolean | undefined,[m
[32m+[m[32m        revocationEndpoint: undefined as boolean | undefined,[m
[32m+[m[32m        errors: [] as string[],[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Test authorization endpoint (should return 400 for missing parameters)[m
[32m+[m[32m    try {[m
[32m+[m[32m        const authResponse = await ssoConnectionPool.request([m
[32m+[m[32m            endpoints.authorizationUrl,[m
[32m+[m[32m            {[m
[32m+[m[32m                method: 'GET',[m
[32m+[m[32m            },[m
[32m+[m[32m        )[m
[32m+[m[32m        // 400 is expected for missing OAuth parameters[m
[32m+[m[32m        results.authorizationEndpoint =[m
[32m+[m[32m            authResponse.status === 400 || authResponse.status === 302[m
[32m+[m[32m        if (!results.authorizationEndpoint) {[m
[32m+[m[32m            results.errors.push([m
[32m+[m[32m                `Authorization endpoint returned unexpected status: ${authResponse.status}`,[m
[32m+[m[32m            )[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (error) {[m
[32m+[m[32m        results.errors.push([m
[32m+[m[32m            `Authorization endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[32m+[m[32m        )[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Test token endpoint (should return 400 for missing parameters)[m
[32m+[m[32m    try {[m
[32m+[m[32m        const tokenResponse = await ssoConnectionPool.request(endpoints.tokenUrl, {[m
[32m+[m[32m            method: 'POST',[m
[32m+[m[32m            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },[m
[32m+[m[32m            body: '',[m
[32m+[m[32m        })[m
[32m+[m[32m        // 400 is expected for missing OAuth parameters[m
[32m+[m[32m        results.tokenEndpoint = tokenResponse.status === 400[m
[32m+[m[32m        if (!results.tokenEndpoint) {[m
[32m+[m[32m            results.errors.push([m
[32m+[m[32m                `Token endpoint returned unexpected status: ${tokenResponse.status}`,[m
[32m+[m[32m            )[m
[32m+[m[32m        }[m
[32m+[m[32m    } catch (error) {[m
[32m+[m[32m        results.errors.push([m
[32m+[m[32m            `Token endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[32m+[m[32m        )[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Test userinfo endpoint if provided (should return 401 for missing token)[m
[32m+[m[32m    if (endpoints.userinfoUrl) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const userinfoResponse = await ssoConnectionPool.request([m
[32m+[m[32m                endpoints.userinfoUrl,[m
[32m+[m[32m                {[m
[32m+[m[32m                    method: 'GET',[m
[32m+[m[32m                },[m
[32m+[m[32m            )[m
[32m+[m[32m            // 401 is expected for missing authorization header[m
[32m+[m[32m            results.userinfoEndpoint = userinfoResponse.status === 401[m
[32m+[m[32m            if (!results.userinfoEndpoint) {[m
[32m+[m[32m                results.errors.push([m
[32m+[m[32m                    `UserInfo endpoint returned unexpected status: ${userinfoResponse.status}`,[m
[32m+[m[32m                )[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            results.userinfoEndpoint = false[m
[32m+[m[32m            results.errors.push([m
[32m+[m[32m                `UserInfo endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[32m+[m[32m            )[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Test revocation endpoint if provided (should return 400 for missing parameters)[m
[32m+[m[32m    if (endpoints.revocationUrl) {[m
[32m+[m[32m        try {[m
[32m+[m[32m            const revocationResponse = await ssoConnectionPool.request([m
[32m+[m[32m                endpoints.revocationUrl,[m
[32m+[m[32m                {[m
[32m+[m[32m                    method: 'POST',[m
[32m+[m[32m                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },[m
[32m+[m[32m                    body: '',[m
[32m+[m[32m                },[m
[32m+[m[32m            )[m
[32m+[m[32m            // 400 is expected for missing parameters[m
[32m+[m[32m            results.revocationEndpoint = revocationResponse.status === 400[m
[32m+[m[32m            if (!results.revocationEndpoint) {[m
[32m+[m[32m                results.errors.push([m
[32m+[m[32m                    `Revocation endpoint returned unexpected status: ${revocationResponse.status}`,[m
[32m+[m[32m                )[m
[32m+[m[32m            }[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m            results.revocationEndpoint = false[m
[32m+[m[32m            results.errors.push([m
[32m+[m[32m                `Revocation endpoint unreachable: ${error instanceof Error ? error.message : 'Unknown error'}`,[m
[32m+[m[32m            )[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return results[m
 }[m
 [m
 /**[m
  * Extract issuer URL from various input formats[m
  */[m
 export function normalizeIssuerUrl(input: string): string {[m
[31m-	try {[m
[31m-		// Handle common input formats[m
[31m-		let url = input.trim()[m
[32m+[m[32m    try {[m
[32m+[m[32m        // Handle common input formats[m
[32m+[m[32m        let url = input.trim()[m
 [m
[31m-		// Add https:// if no protocol specified[m
[31m-		if (!url.startsWith('http://') && !url.startsWith('https://')) {[m
[31m-			url = `https://${url}`[m
[31m-		}[m
[32m+[m[32m        // Add https:// if no protocol specified[m
[32m+[m[32m        if (!url.startsWith('http://') && !url.startsWith('https://')) {[m
[32m+[m[32m            url = `https://${url}`[m
[32m+[m[32m        }[m
 [m
[31m-		// Remove trailing slash[m
[31m-		url = url.replace(/\/$/, '')[m
[32m+[m[32m        // Remove trailing slash[m
[32m+[m[32m        url = url.replace(/\/$/, '')[m
 [m
[31m-		// Validate URL format[m
[31m-		new URL(url) // This will throw if invalid[m
[32m+[m[32m        // Validate URL format[m
[32m+[m[32m        new URL(url) // This will throw if invalid[m
 [m
[31m-		return url[m
[31m-	} catch {[m
[31m-		throw new Error(`Invalid issuer URL format: ${input}`)[m
[31m-	}[m
[32m+[m[32m        return url[m
[32m+[m[32m    } catch {[m
[32m+[m[32m        throw new Error(`Invalid issuer URL format: ${input}`)[m
[32m+[m[32m    }[m
 }[m
 [m
 [m
[36m@@ -569,42 +569,42 @@[m [mexport function normalizeIssuerUrl(input: string): string {[m
  * Get well-known OIDC discovery URL for an issuer[m
  */[m
 export function getDiscoveryUrl(issuerUrl: string): string {[m
[31m-	const normalizedIssuer = normalizeIssuerUrl(issuerUrl)[m
[31m-	return `${normalizedIssuer}/.well-known/openid-configuration`[m
[32m+[m[32m    const normalizedIssuer = normalizeIssuerUrl(issuerUrl)[m
[32m+[m[32m    return `${normalizedIssuer}/.well-known/openid-configuration`[m
 }[m
 [m
 /**[m
  * Common OIDC provider configurations for quick setup[m
  */[m
 export const COMMON_PROVIDERS = {[m
[31m-	okta: {[m
[31m-		name: 'Okta',[m
[31m-		discoveryPath: '/.well-known/openid-configuration',[m
[31m-		scopes: 'openid email profile',[m
[31m-		supportsRefresh: true,[m
[31m-		supportsPKCE: true,[m
[31m-	},[m
[31m-	'azure-ad': {[m
[31m-		name: 'Azure Active Directory',[m
[31m-		discoveryPath: '/v2.0/.well-known/openid-configuration',[m
[31m-		scopes: 'openid email profile',[m
[31m-		supportsRefresh: true,[m
[31m-		supportsPKCE: true,[m
[31m-	},[m
[31m-	auth0: {[m
[31m-		name: 'Auth0',[m
[31m-		discoveryPath: '/.well-known/openid-configuration',[m
[31m-		scopes: 'openid email profile',[m
[31m-		supportsRefresh: true,[m
[31m-		supportsPKCE: true,[m
[31m-	},[m
[31m-	google: {[m
[31m-		name: 'Google',[m
[31m-		discoveryPath: '/.well-known/openid-configuration',[m
[31m-		scopes: 'openid email profile',[m
[31m-		supportsRefresh: true,[m
[31m-		supportsPKCE: true,[m
[31m-	},[m
[32m+[m[32m    okta: {[m
[32m+[m[32m        name: 'Okta',[m
[32m+[m[32m        discoveryPath: '/.well-known/openid-configuration',[m
[32m+[m[32m        scopes: 'openid email profile',[m
[32m+[m[32m        supportsRefresh: true,[m
[32m+[m[32m        supportsPKCE: true,[m
[32m+[m[32m    },[m
[32m+[m[32m    'azure-ad': {[m
[32m+[m[32m        name: 'Azure Active Directory',[m
[32m+[m[32m        discoveryPath: '/v2.0/.well-known/openid-configuration',[m
[32m+[m[32m        scopes: 'openid email profile',[m
[32m+[m[32m        supportsRefresh: true,[m
[32m+[m[32m        supportsPKCE: true,[m
[32m+[m[32m    },[m
[32m+[m[32m    auth0: {[m
[32m+[m[32m        name: 'Auth0',[m
[32m+[m[32m        discoveryPath: '/.well-known/openid-configuration',[m
[32m+[m[32m        scopes: 'openid email profile',[m
[32m+[m[32m        supportsRefresh: true,[m
[32m+[m[32m        supportsPKCE: true,[m
[32m+[m[32m    },[m
[32m+[m[32m    google: {[m
[32m+[m[32m        name: 'Google',[m
[32m+[m[32m        discoveryPath: '/.well-known/openid-configuration',[m
[32m+[m[32m        scopes: 'openid email profile',[m
[32m+[m[32m        supportsRefresh: true,[m
[32m+[m[32m        supportsPKCE: true,[m
[32m+[m[32m    },[m
 } as const[m
 [m
 export type CommonProvider = keyof typeof COMMON_PROVIDERS[m
